import{generateWords}from"./generate.js";import{showAnalytics}from"./statistics.js";export class GameState{constructor(){this.cusorPos=0,this.state="idle",this.lettersTyped=0,this.startTime=null,this.endTime=null,this.mistakes=[],this.wpmTimeSeries=[],this.wordPos=0,this.words=[],this.wordDivs=[],this.letterDivs=[],this.language="english",this.wordAmount=50}reset(){this.lettersTyped=0,this.startTime=null,this.endTime=null,this.letterDivs=[],this.wordDivs=[],this.state="idle",this.cusorPos=0,this.wordPos=0}async newWords(){console.log("generating with language: ",this.language," amount: ",this.wordAmount),this.reset(),this.words=await generateWords(this.wordAmount,{language:this.language,mode:this.mode}),this.wordAmount=this.words.length}loadPreferences(){this.language=localStorage.getItem("typing-language")||"english",this.mode=localStorage.getItem("typing-mode")||"words",this.wordAmount=parseInt(localStorage.getItem("typing-words"))||25}listen(){window.addEventListener("opts-change",function(){let e=localStorage.getItem("typing-language")||"english"})}async renderWords(){let e=document.getElementById("content");e.innerHTML="";let t=document.createElement("div");t.classList.add("blinking-cursor"),e.appendChild(t);for(let t=0;t<this.words.length;t++){let o=this.words[t].split(""),n=document.createElement("div");n.style.display="flex";for(let s=0;s<o.length;s++){let e=document.createElement("div");e.innerText=o[s],e.classList.add("letter"),t==0&&s==0&&(e.style.marginLeft="0px"),n.appendChild(e),this.letterDivs.push(e)}this.wordDivs.push(n),e.appendChild(n);let s=document.createElement("div");s.classList.add("spacer"),this.wordDivs.push(s),this.letterDivs.push(s),e.appendChild(s)}}input(e){if(this.state=="idle"&&(this.state="running",this.startTime=Date.now()),e.key=="Backspace")this.moveCursor(this.cusorPos,this.cusorPos-1>=0?this.cusorPos-1:0);else{this.moveCursor(this.cusorPos,this.cusorPos+1);let t=this.letterDivs[this.cusorPos-1];e.key==t.innerText?t.style.color="var(--correct-font-color)":t.innerText!=""&&(t.style.color="var(--wrong-font-color)",console.log("mistake: ",t.innerText," typed: ",e.key),this.mistakes.push(Date.now()-this.startTime)),this.lettersTyped++}let t=this.letterDivs[this.cusorPos-1],s=document.getElementById("content"),o=t.parentElement;const n=Array.prototype.indexOf.call(s.children,o);if(n!=-1?this.wordPos=n/2:(console.log("reached end of word: ",this.wordPos+1),this.wpmTimeSeries.push(Date.now()-this.startTime)),t==this.letterDivs[this.letterDivs.length-1]){console.log("reached real end"),this.state="finished",this.endTime=Date.now();let e=(this.endTime-this.startTime)/1e3;console.log("Time: "+e+" seconds"),console.log("word time series: ",this.wpmTimeSeries),console.log("mistakes: ",this.mistakes);let t=this.wordAmount/(e/60);console.log("WPM: "+t),showAnalytics(this)}}moveCursor(e,t){this.cusorPos=t;let s=document.querySelector(".blinking-cursor"),o=document.getElementById("content");try{o.removeChild(s);for(let e=0;e<o.children.length;e++)o.children[e].removeChild(s)}catch{}let n=this.letterDivs[this.cusorPos],i=this.letterDivs[this.cusorPos-1],a=this.letterDivs[this.cusorPos+1];n&&(n.style.color="var(--font-color)"),t<e&&n&&a?(n.style.marginLeft="0px",a.style.marginLeft="2px",n.parentElement.insertBefore(s,n)):n&&i&&(i.style.marginLeft="2px",n.style.marginLeft="0px",n.parentElement.insertBefore(s,n))}}