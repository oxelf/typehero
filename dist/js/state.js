import{generateWords as h}from"./generate.js";import{showAnalytics as a}from"./statistics.js";export class GameState{constructor(){this.cusorPos=0,this.state="idle",this.lettersTyped=0,this.startTime=null,this.endTime=null,this.mistakes=[],this.wpmTimeSeries=[],this.wordPos=0,this.words=[],this.letterDivs=[],this.language="english",this.wordAmount=50}reset(){this.lettersTyped=0,this.startTime=null,this.endTime=null,this.letterDivs=[],this.state="idle",this.cusorPos=0,this.wordPos=0}async newWords(){console.log("generating with language: ",this.language," amount: ",this.wordAmount),this.reset();let s=await h(this.wordAmount,{language:this.language,mode:this.mode});this.words=s.words,this.author=s.author,this.wordAmount=this.words.length}loadPreferences(){this.language=localStorage.getItem("typing-language")||"english",this.mode=localStorage.getItem("typing-mode")||"words",this.wordAmount=parseInt(localStorage.getItem("typing-words"))||25}async renderWords(){let s=document.getElementById("content");s.innerHTML="";let l=document.createElement("div");l.classList.add("blinking-cursor"),s.appendChild(l);for(let o=0;o<this.words.length;o++){let n=this.words[o].split(""),e=document.createElement("div");e.classList.add("word");for(let t=0;t<n.length;t++){let i=document.createElement("div");i.innerText=n[t],i.classList.add("letter"),o==0&&t==0&&(i.style.marginLeft="0px"),e.appendChild(i),this.letterDivs.push(i)}s.appendChild(e);let r=document.createElement("div");r.classList.add("spacer"),this.letterDivs.push(r),s.appendChild(r)}this.mode=="quote"?document.getElementById("quote-author").innerText=`Quote from "${this.author}"`:document.getElementById("quote-author").innerText=""}input(s){if(this.state=="idle"&&(this.state="running",this.startTime=Date.now()),s.key=="Backspace")this.moveCursor(this.cusorPos,this.cusorPos-1>=0?this.cusorPos-1:0);else{this.moveCursor(this.cusorPos,this.cusorPos+1);let t=this.letterDivs[this.cusorPos-1];t&&(s.key==t.innerText?t.style.color="var(--correct-font-color)":t.innerText!=""&&(t.style.color="var(--wrong-font-color)",console.log("mistake: ",t.innerText," typed: ",s.key),this.mistakes.push(Date.now()-this.startTime))),this.lettersTyped++}let l=this.letterDivs[this.cusorPos-1],o=this.letterDivs[this.cusorPos];if(!l)return;let n=document.getElementById("content"),e=l.parentElement;const r=Array.prototype.indexOf.call(n.children,e);if(r!=-1?this.wordPos=r/2:this.wpmTimeSeries.push(Date.now()-this.startTime),o==this.letterDivs[this.letterDivs.length-1]){console.log("reached real end"),this.state="finished",this.endTime=Date.now();let t=(this.endTime-this.startTime)/1e3;console.log("Time: "+t+" seconds"),console.log("word time series: ",this.wpmTimeSeries),console.log("mistakes: ",this.mistakes);let i=this.wordAmount/(t/60);console.log("WPM: "+i),a(this)}}moveCursor(s,l){this.cusorPos=l;let o=document.querySelector(".blinking-cursor"),n=document.getElementById("content");try{n.removeChild(o);for(let i=0;i<n.children.length;i++)n.children[i].removeChild(o)}catch{}let e=this.letterDivs[this.cusorPos],r=this.letterDivs[this.cusorPos-1],t=this.letterDivs[this.cusorPos+1];e&&(e.style.color="var(--font-color)"),l<s&&e&&t?(e.style.marginLeft="0px",t.style.marginLeft="2px",e.parentElement.insertBefore(o,e)):e&&r&&(r.style.marginLeft="2px",e.style.marginLeft="0px",e.parentElement.insertBefore(o,e))}}
